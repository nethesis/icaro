---
- name: Install yum-plugin-copr
  yum:
    name: yum-plugin-copr
    state: present

- name: Enable Caddy CORP
  shell:  yum copr enable -y @caddy/caddy

- name: Install Caddy HTTP/2 web server
  yum:
    name: caddy
    state: present

- name: Copy Caddy envfile
  template:
    src: icaro-caddy-envfile.j2
    dest: /etc/caddy/envfile

- name: Copy Caddy configs
  template:
    src: Caddyfile.j2
    dest:  /etc/caddy/Caddyfile

- name: Grant caddy to bind on low ports
  capabilities:
    path: /usr/bin/caddy
    capability: cap_net_bind_service=+ep
    state: present

- name: Make caddy start after cloud-init (create dir)
  file:
    name: /etc/systemd/system/caddy.service.d
    state: directory

- name: Make caddy start after cloud-init (copy file)
  copy:
    src: etc/systemd/system/caddy.service.d/override.conf
    dest: /etc/systemd/system/caddy.service.d/override.conf

- name: Disable SELinux
  selinux:
    state: disabled

- name: Enable Caddy server
  service:
    name: caddy
    enabled: yes
