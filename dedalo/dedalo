#!/bin/sh
OPT=$1
shift
source /opt/icaro/dedalo/config

MAC_ADDRESS=$(cat /sys/class/net/$HS_INTERFACE/address 2>/dev/null| tr ':' '-' | awk '{print toupper($0)}')

case "$OPT" in
    query)
        /usr/sbin/chilli_query -s /run/dedalo/chilli.sock "$@"
    ;;
    config)
        /opt/icaro/dedalo/template/engine /opt/icaro/dedalo/template/chilli.conf.tpl
        if [ $? -eq 0 ]; then
            echo "Configuration generated successfully"
        else
            echo "Error on configuration generating"
        fi
    ;;
    register)
        # get opts
        while getopts ":u:p:" o; do
            case "${o}" in
                u)
                    USERNAME=${OPTARG}
                    ;;
                p)
                    PASSWORD=${OPTARG}
                    ;;
                *)
                    exit 1
                    ;;
            esac
        done
        # check if username exists
        if [ -z "$USERNAME" ]; then
            echo "Username is required, use -u <username>"
            exit 1
        fi
        # check if password exists
        if [ -z "$PASSWORD" ]; then
            echo "Password is required, use -p <password>"
            exit 1
        fi
        # get auth token using /login API
        TOKEN=$(curl -s --request POST \
            --url "$HS_API_URL/login" \
            --header "Content-Type: application/json" \
            --data "{
                \"username\": \"$USERNAME\",
                \"password\": \"$PASSWORD\"
            }" | jq -r '.token')
        # create a new unit using /units API
        RESP=$(curl -s --request POST \
            --url "$HS_API_URL/units" \
            --header 'Content-Type: application/json' \
            --header "Token: $TOKEN" \
            --data "{
                \"mac_address\": \"$MAC_ADDRESS\",
                \"description\": \"$HS_UNIT_NAME\",
                \"uuid\": \"$HS_UUID\",
                \"secret\": \"$HS_SECRET\",
                \"hotspot_id\": 1
            }")
        # check if everything is ok
        ID=$(echo $RESP | jq -r '.id')
        STATUS=$(echo $RESP | jq -r '.status')
        if [ $? -eq 0 ] && [ "$STATUS" == "success" ]; then
            if [ "$ID" == "0" ]; then
                echo "Unit already added"
            else
                echo "Unit added successfully"
            fi
        else
            echo "Error on unit adding"
        fi
    ;;
    start)
        systemctl start dedalo
    ;;
    restart)
        systemctl restart dedalo
    ;;
    stop)
        systemctl stop dedalo
    ;;
    status)
        systemctl status dedalo
    ;;
    info)
        echo "Dedalo: Network Access Controller"
        echo -e "  HotSpot ID:\t$HS_ID"
        echo -e "  Unit Name:\t$HS_UNIT_NAME"
        echo -e "  Unit UUID:\t$HS_UUID"
        echo -e "  Unit Secret:\t$HS_SECRET"
        echo -e "  Unit MAC:\t$MAC_ADDRESS"
    ;;
    *)
        echo "Usage: $0 { query | config | register | start | stop | restart | status | info }"
esac
